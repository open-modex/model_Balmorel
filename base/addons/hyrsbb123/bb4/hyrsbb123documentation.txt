$ontext
Hans Ravn
Preliminary. Revised 20170412.

Addon  HYDROBB123


* For model BB3 it is possible to use values found from BB1 or BB2 solutions to achieve use of hydro power
* that corresponds to that found in a BB1 or BB2 solution.
$setglobal HYDROBB123 quantprice
*!option quant        "Use seasonal quantities of hydro generation (from HYRSG.gdx) in BB3 ('primal decomposition')"
*!mayif %BB3%==yes
*!option price        "Use seasonal prices for hydro generation (from WATERVAL.gdx) in BB3 ('dual decomposition')"
*!mayif %BB3%==yes
*!option quantprice   "Use seasonal quantities and prices for hydro generation (from HYRSG.gdx?? and WATERVAL.gdx) in BB3"
*!mayif %BB3%==yes
*!option none         "Do not not use this hydro addon"
*!mustif not %BB3%==yes
$ifi not %BB3%==yes $setglobal HYDROBB123 none


The option replaces controls:  MAKEWATER and  WATERVAL.

This option variable has influence on hydro with storage and no influence on hydro run of river.

For any of the options it makes sense to use it only if the seasons in S (SET S) are the same for BB3 and BB1/BB2, and have the same relative weights (WEIGHT_S).
(might be permitted in later versions)

Allocates a fixed hydro quantity WATERVOL for use in each season, this volume was generated by a BB1 or BB2 solution and saved as simex\WATERVOL.gdx.
That amount may be exceeded at a marginal cost. That cost depends on the water values WATERVAL found in the BB1 or BB2 solution and saved as simex\WATERVAL.gdx.
The cost will be somewhat higher that the cost given in WATERVAL and will increase by increasing hydro amounts used.
General:

After successful solution from BB1 or BB2 the water values, hydro production and beginning-of-season storage volumes will be saved to files WATERVAL.gdx, HYRSG.gdx and WATERVOLINI.gdx.
These parameters are declared in Balmorel and saved irrespective of the chosen option for HYDROBB123.
Values saved (unconditionally) to folder simex as gdx files:
  HYRSG.gdx', HYRSG;
  VHYRS_SL.gdx', VHYRS_S.L;
  WATERVAL.gdx', WATERVAL;

When BB3 is to be solved these values are loaded into Balmorel. What happens next depends in the option chosen.
Option specific:

For %HYDROBB123%==quant:
Equation QWATERVOLINI is part of model BALBASE3. This limits the hydro energy generation to the same as found in the BB1/BB2 solution, known from VHYRS_SL.gdx.
Values saved (conditionally) to folder simex af gdx files with option quant :
  HYRSG.gdx',HYRSG;
  WATERVAL.gdx',WATERVAL;

For %HYDROBB123%==price:
Equation QWATERVOLINI is not part of model BALBASE3. In the objective function QOBJ the water values found in BB1/BB2, known from VHYRS_SL.gdx,
are used as marginal cost for hydro power generation.
Values saved to folder simex af gdx files with option price:
  HYRSG.gdx',HYRSG;
  WATERVAL.gdx',WATERVAL;

For %HYDROBB123%==quantprice:

Before entering the loop over seasons the hydro volumes for the beginning of the first season are fixed to that of the BB1/BB2 solution,
which is known from VHYRS_SL.gdx (containing values VHYRS_S.L).

When  BB3 is solved for a season the equation QWATERVOLINI attempts to limit the use of hydro power each season
to not exceed what was found in BB1/BB2. QWATERVOLINI is located in Balmorel.gms. todo-noget inkonsistent...
The limit may be exceeded at marginal costs which for smaller amounts are not much higher than the water values found in BB1/BB2,
known from WATERVAL.gdx, but if more is used the marginal costs increase.
In the objective function QOBJ the cost of hydro power generation is the same as given as variable costs XXX .
If the hydro amounts used exceed what was found in BB1/BB2 an additional variable cost component is added in QOBJ.

In the loop over seasons a bookkeeping mechanism tracks the amounts of water used in current season and accumulated over the simulated seasons.
Similarly the amounts of water use for BB1/BB2 by season (known from VHYRS_SL.gdx) and accumulated over the simulated seasons are kept track of.

If after the solution for a particular season it is found that there is a deviation between the accumulated amounts for BB3 and BB1/BB2
then data is manipulated with the aim to restore accumulated amounts for the remaining seasons.
The available main mechanisms are tightening of equation QWATERVOLINI and increase of the marginal cost for exceeding that level.

If variable VHYRS_S (hydro energy equivalent (storage level) at the start of the season (MWh))
were declared as a positive variable an error would be issued in case of negative values of IHYDROBB123VOLINI,
cf. equation QWATERVOLINI which essentially states that VHYRS_S =E= IHYDROBB123VOLINI.
To avoid this, the variable VHYRS_S is declared as a free variable for model BB3 (while positive in models BB1 and BB2).
The sole intention of equation IHYDROBB123VOLINI is to permit convenient comparison with the BB1/BB2 solution through VHYRS_S.

Values saved to folder simex af gdx files with option quantprice:
  HYRSG_bb3.gdx',HYRSG;
  VHYRS_SL_bb3.gdx',VHYRS_S.L;
  WATERVAL_bb3.gdx',WATERVAL; ?


Some details:
PARAMETER IHYRSG_Y(AAA,SSS)             "Water (hydro) generation quantity of the seasons transferred from model BB1/BB2 for use in model Balbase3 (MWh)" ;
PARAMETER IWATERVOL_Y(AAA,SSS)          "Water quantity (storage level at beginning of season) transferred from model BB1/BB2 for use in model Balbase3 (MWh)" ;
PARAMETER IWATERVAL_Y(AAA,SSS)          "Water value (in input Money) transferred from model BB1/BB2 for use in model Balbase3 (MWh)" ;
SET IHYDROBB12DELTASET                  "Increase steps of hydro generation above BB1 level" / IBB123HYG1*IBB123HYG5  /;
PARAMETER IHYDROBB123BB3GACCUM(AAA)     "The amount of water used so far during present year during BB3 solutions (MWh)";
PARAMETER IHYDROBB123BB12GACCUM(AAA)    "The amount of water used so far during present year according to BB1/BB2 solution (MWh)";
PARAMETER IHYDROBB123DELTAVOL(AAA)      "Amount of additional hydro energy (relative to BB1/BB2) pre-allocated this season (may be negative) in model BB3 (MWh)";
PARAMETER IHYDROBB123VOLINI(AAA,S)      "Initial storage level (MWh)";
PARAMETER VHYRS_SL(Y,AAA,S)             "To be saved for comparison with BB1/BB2 solution value for VHYRS_S.L (declared as a parameter) (MWh)";
PARAMETER IHYDROBB123EXTRAVAL(AAA,S,IHYDROBB12DELTASET) "";

POSITIVE VARIABLE VIHYRSBB12DELTAMHW(AAA,IHYDROBB12DELTASET) "Amount of additional hydro energy allocated this season during optimization of model Balbase3 (MWh)";

EQUATION    QWATERVOLINI(AAA,S)         "Hydro energy (volume) in storage at the beginning of season in model Balbase3 (MWh)" ;
EQUATION    QHYRSG(AAA,S)               "Hydro energy available for this region and season in model Balbase3 (MWh)";


$offtext
